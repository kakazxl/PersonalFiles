### 进程分配内存策略

如果单次分配内存小于128k，采用brk分配策略；否则采用mmap分配策略。在分配了内存页之后，如果不使用内存，不会分配物理内存。只有使用的时候，触发缺页终端，进行实际的物理内存分配。

#### brk策略

1. 进入系统调用函数sys_brk。

2. 将原来的堆顶和现在的堆顶，都按照页对齐地址，然后比较大小。如果两者相同，说明增加的堆的量很小，还在一个页里面，不需要另行分配页，直接跳到 set_brk 那里，设置 mm->brk 为新的 brk 就可以了。

3. 如果发现新旧堆顶不在一个页里面，就需要跨页。

   - 如果发现新堆顶小于旧堆顶，说明释放内存了，于是调用 do_munmap 将这一页的内存映射去掉。

   - 如果堆将要扩大，就要对红黑树的查找，找到的是原堆顶所在的 vm_area_struct 的下一个 vm_area_struct，看当前的堆顶和下一个 vm_area_struct 之间还能不能分配一个完整的页。如果不能就退出，内存空间都被占满了。

   - 如果还有空间，就从旧堆顶开始，分配计算出的新旧堆顶之间的页数。接下来看这个新节点是否能够和现有树中的节点合并。如果地址是连着的，能够合并，则不用创建新的 vm_area_struct 了，直接更新统计值即可；如果不能合并，则创建新的 vm_area_struct，既加到 anon_vma_chain 链表中，也加到红黑树中。

#### mmap分配策略

1. 用户态内存映射函数 mmap，包括用它来做匿名映射和文件映射。
2. 用户态的页表结构，存储位置在 mm_struct 中。在用户态访问没有映射的内存会引发缺页异常，分配物理页表、补齐页表。
3. 如果是匿名映射则分配物理内存；如果是 swap，则将 swap 文件读入；如果是文件映射，则将文件读入。
