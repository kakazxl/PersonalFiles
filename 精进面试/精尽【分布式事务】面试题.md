# ç²¾å°½ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€‘é¢è¯•é¢˜



ä»¥ä¸‹é¢è¯•é¢˜ï¼ŒåŸºäºç½‘ç»œæ•´ç†ï¼Œå’Œè‡ªå·±ç¼–è¾‘ã€‚å…·ä½“å‚è€ƒçš„æ–‡ç« ï¼Œä¼šåœ¨æ–‡æœ«ç»™å‡ºæ‰€æœ‰çš„é“¾æ¥ã€‚

å¦‚æœèƒ–å‹æœ‰è‡ªå·±çš„ç–‘é—®ï¼Œæ¬¢è¿åœ¨æ˜Ÿçƒæé—®ï¼Œæˆ‘ä»¬ä¸€èµ·æ•´ç†åŠåŠçš„ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€‘é¢è¯•é¢˜çš„å¤§ä¿å¥ã€‚

è€Œé¢˜ç›®çš„éš¾åº¦ï¼Œè‰¿è‰¿å°½é‡æŒ‰ç…§ä»å®¹æ˜“åˆ°å›°éš¾çš„é¡ºåºï¼Œé€æ­¥ä¸‹å»ã€‚

## ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

åˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯æŒ‡äº‹åŠ¡çš„å‚ä¸è€…ã€æ”¯æŒäº‹åŠ¡çš„æœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠäº‹åŠ¡ç®¡ç†å™¨åˆ†åˆ«ä½äºä¸åŒçš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹ä¹‹ä¸Šã€‚ç®€å•çš„è¯´ï¼Œå°±æ˜¯ä¸€æ¬¡å¤§çš„æ“ä½œç”±ä¸åŒçš„å°æ“ä½œç»„æˆï¼Œè¿™äº›å°çš„æ“ä½œåˆ†å¸ƒåœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä¸”å±äºä¸åŒçš„åº”ç”¨ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡éœ€è¦ä¿è¯è¿™äº›å°æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯ä¸ºäº†ä¿è¯ä¸åŒæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ã€‚

æˆ–è€…ï¼Œåœ¨æ¢ä¸€å¥è¯è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ = n ä¸ªæœ¬åœ°äº‹åŠ¡ã€‚é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨ï¼Œè¾¾åˆ° n ä¸ªæœ¬åœ°äº‹åŠ¡è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

## ä¸ºä»€ä¹ˆä¼šæœ‰åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

ä»æœ¬åœ°äº‹åŠ¡æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸ºä¸¤å—ï¼Œä¸€ä¸ªæ˜¯ service äº§ç”Ÿå¤šä¸ªèŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªæ˜¯ resource äº§ç”Ÿå¤šä¸ªèŠ‚ç‚¹ã€‚

ğŸ˜ˆ å¯èƒ½ä¼šæœ‰èƒ–è¯´ï¼Œæˆ‘ä»¬å°±æ˜¯ä¸€ä¸ªå•ä½“åº”ç”¨ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚OK ï¼Œæ²¡é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å›è¿‡å¤´æ¥æƒ³æƒ³ç”¨æˆ·ä¸‹å•å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦ç»™ç”¨æˆ·å‘çŸ­ä¿¡ã€‚å¦‚æœå‘é€çŸ­ä¿¡å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨çš„åŸå› ï¼Œæˆ‘ä»¬æ˜¯ä¸åº”è¯¥å»å›æ»šæœ¬åœ°äº‹åŠ¡ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ã€‚

1ï¼‰service å¤šä¸ªèŠ‚ç‚¹

éšç€äº’è”ç½‘å¿«é€Ÿå‘å±•ï¼Œå¾®æœåŠ¡ï¼ŒSOAç­‰æœåŠ¡æ¶æ„æ¨¡å¼æ­£åœ¨è¢«å¤§è§„æ¨¡çš„ä½¿ç”¨ï¼Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¸€ä¸ªå…¬å¸ä¹‹å†…ï¼Œç”¨æˆ·çš„èµ„äº§å¯èƒ½åˆ†ä¸ºå¥½å¤šä¸ªéƒ¨åˆ†ï¼Œæ¯”å¦‚ä½™é¢ï¼Œç§¯åˆ†ï¼Œä¼˜æƒ åˆ¸ç­‰ç­‰ã€‚åœ¨å…¬å¸å†…éƒ¨æœ‰å¯èƒ½ç§¯åˆ†åŠŸèƒ½ç”±ä¸€ä¸ªå¾®æœåŠ¡å›¢é˜Ÿç»´æŠ¤ï¼Œä¼˜æƒ åˆ¸åˆæ˜¯å¦å¤–çš„å›¢é˜Ÿç»´æŠ¤ã€‚



è¿™æ ·çš„è¯å°±æ— æ³•ä¿è¯ç§¯åˆ†æ‰£å‡äº†ä¹‹åï¼Œä¼˜æƒ åˆ¸èƒ½å¦æ‰£å‡æˆåŠŸã€‚

2ï¼‰resource å¤šä¸ªèŠ‚ç‚¹

åŒæ ·çš„ï¼Œäº’è”ç½‘å‘å±•å¾—å¤ªå¿«äº†ï¼Œæˆ‘ä»¬çš„Mysqlä¸€èˆ¬æ¥è¯´è£…åƒä¸‡çº§çš„æ•°æ®å°±å¾—è¿›è¡Œåˆ†åº“åˆ†è¡¨ï¼Œå¯¹äºä¸€ä¸ªæ”¯ä»˜å®çš„è½¬è´¦ä¸šåŠ¡æ¥è¯´ï¼Œä½ ç»™çš„æœ‹å‹è½¬é’±ï¼Œæœ‰å¯èƒ½ä½ çš„æ•°æ®åº“æ˜¯åœ¨åŒ—äº¬ï¼Œè€Œä½ çš„æœ‹å‹çš„é’±æ˜¯å­˜åœ¨ä¸Šæµ·ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¾ç„¶æ— æ³•ä¿è¯ä»–ä»¬èƒ½åŒæ—¶æˆåŠŸã€‚

![img](http://static.iocoder.cn/d25d3a43ddbcbc256913e4b6622d88a3)

ğŸ˜ˆ å¯èƒ½ä¼šæœ‰èƒ–å‹è¯´ï¼Œæˆ‘ä»¬æ•°æ®æ²¡åšåˆ†åº“åˆ†è¡¨ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚OKï¼Œæ²¡é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å›è¿‡å¤´æ¥æƒ³æƒ³æœ€å¸¸è§çš„åœºæ™¯ï¼Œç³»ç»Ÿé‡Œå¼•å…¥äº† Redis åšç¼“å­˜ï¼Œé‚£ä¹ˆ DB å’Œ Redis çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå°±æ˜¯ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„åœºæ™¯ã€‚

ğŸ¦… **æ˜¯å¦çœŸçš„è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**

åœ¨è¯´åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ¡ˆä¹‹å‰ï¼Œé¦–å…ˆä½ ä¸€å®šè¦æ˜ç¡®ä½ æ˜¯å¦çœŸçš„éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

ä¸Šé¢è¯´è¿‡å‡ºç°åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸¤ä¸ªåŸå› ï¼Œå…¶ä¸­æœ‰ä¸ªåŸå› æ˜¯å› ä¸ºå¾®æœåŠ¡è¿‡å¤šã€‚æˆ‘è§è¿‡å¤ªå¤šå›¢é˜Ÿä¸€ä¸ªäººç»´æŠ¤å‡ ä¸ªå¾®æœåŠ¡ï¼Œå¤ªå¤šå›¢é˜Ÿè¿‡åº¦è®¾è®¡ï¼Œæå¾—æ‰€æœ‰äººç–²åŠ³ä¸å ªï¼Œè€Œå¾®æœåŠ¡è¿‡å¤šå°±ä¼šå¼•å‡ºåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä¸ä¼šå»ºè®®ä½ å»é‡‡ç”¨åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ¡ˆï¼Œè€Œæ˜¯è¯·æŠŠéœ€è¦äº‹åŠ¡çš„å¾®æœåŠ¡èšåˆæˆä¸€ä¸ªå•æœºæœåŠ¡ï¼Œä½¿ç”¨æ•°æ®åº“çš„æœ¬åœ°äº‹åŠ¡ã€‚å› ä¸ºä¸è®ºä»»ä½•ä¸€ç§æ–¹æ¡ˆéƒ½ä¼šå¢åŠ ä½ ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè¿™æ ·çš„æˆæœ¬å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œåƒä¸‡ä¸è¦å› ä¸ºè¿½æ±‚æŸäº›è®¾è®¡ï¼Œè€Œå¼•å…¥ä¸å¿…è¦çš„æˆæœ¬å’Œå¤æ‚åº¦ã€‚

å½“ç„¶ï¼Œå¦‚æœä½ æ˜¯ä¸ªäººçš„ç»ƒä¹  Demo é¡¹ç›®ï¼Œè¯·ä½¿åŠ²çš„é€ ï¼Œæ‹¼å‘½çš„ç©ã€‚ç”šè‡³è¯´ï¼Œæˆ‘å»ºè®®ä½ èƒ½è¯»å®Œæ‰€ä½¿ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ¡ˆçš„åŸç†å’Œæºç ã€‚å› ä¸ºï¼Œä¸€æ—¦ä¸Šäº†ç”Ÿäº§ï¼Œå‡ºäº†é—®é¢˜ï¼Œä½ å¾ˆæœ‰å¯èƒ½æ— ä»ä¸‹æ‰‹~

æ‰€ä»¥ï¼Œæƒ³æ¸…æ¥šä½ æ˜¯å¦éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½ æ˜¯å¦èƒ½å¤Ÿ hold ä½åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆã€‚

## åˆ†å¸ƒå¼äº‹åŠ¡çš„åŸºç¡€ï¼Ÿ

æ•°æ®åº“çš„ ACID æ»¡è¶³äº†æ•°æ®åº“æœ¬åœ°äº‹åŠ¡çš„åŸºç¡€ï¼Œä½†æ˜¯å®ƒæ— æ³•æ»¡è¶³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¿™ä¸ªæ—¶å€™è¡ç”Ÿäº† CAP å’Œ BASE ä¸¤ä¸ªç»å…¸ç†è®ºã€‚

ğŸ¦… **CAP ç†è®º**

CAP å®šç†ï¼Œåˆè¢«å«ä½œå¸ƒé²å°”å®šç†ã€‚å¯¹äºè®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´(ä¸ä»…ä»…æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡)çš„æ¶æ„å¸ˆæ¥è¯´ï¼ŒCAP å°±æ˜¯ä½ çš„å…¥é—¨ç†è®ºã€‚

- C (ä¸€è‡´æ€§)ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ‰€æœ‰æ•°æ®å¤‡ä»½ï¼Œåœ¨åŒä¸€æ—¶åˆ»æ˜¯å¦åŒæ ·çš„å€¼ã€‚ï¼ˆç­‰åŒäºæ‰€æœ‰èŠ‚ç‚¹è®¿é—®åŒä¸€ä»½æœ€æ–°çš„æ•°æ®å‰¯æœ¬ï¼‰
- A (å¯ç”¨æ€§)ï¼šåœ¨é›†ç¾¤ä¸­ä¸€éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœåï¼Œé›†ç¾¤æ•´ä½“æ˜¯å¦è¿˜èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯»å†™è¯·æ±‚ã€‚ï¼ˆå¯¹æ•°æ®æ›´æ–°å…·å¤‡é«˜å¯ç”¨æ€§ï¼‰
- P (åˆ†åŒºå®¹é”™æ€§)ï¼šä»¥å®é™…æ•ˆæœè€Œè¨€ï¼Œåˆ†åŒºç›¸å½“äºå¯¹é€šä¿¡çš„æ—¶é™è¦æ±‚ã€‚ç³»ç»Ÿå¦‚æœä¸èƒ½åœ¨æ—¶é™å†…è¾¾æˆæ•°æ®ä¸€è‡´æ€§ï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†åˆ†åŒºçš„æƒ…å†µï¼Œå¿…é¡»å°±å½“å‰æ“ä½œåœ¨ C å’Œ A ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚

é«˜å¯ç”¨ã€æ•°æ®ä¸€è‡´æ€§æ˜¯å¾ˆå¤šç³»ç»Ÿè®¾è®¡çš„ç›®æ ‡ï¼Œä½†æ˜¯åˆ†åŒºåˆæ˜¯ä¸å¯é¿å…çš„äº‹æƒ…ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹åˆ†åˆ«æ‹¥æœ‰ CAã€CP å’Œ AP çš„æƒ…å†µã€‚

- CA without Pï¼šå¦‚æœä¸è¦æ±‚ Pï¼ˆä¸å…è®¸åˆ†åŒºï¼‰ï¼Œåˆ™ Cï¼ˆå¼ºä¸€è‡´æ€§ï¼‰å’ŒAï¼ˆå¯ç”¨æ€§ï¼‰æ˜¯å¯ä»¥ä¿è¯çš„ã€‚ä½†å…¶å®åˆ†åŒºä¸æ˜¯ä½ æƒ³ä¸æƒ³çš„é—®é¢˜ï¼Œè€Œæ˜¯å§‹ç»ˆä¼šå­˜åœ¨ï¼Œå› æ­¤ CA çš„ç³»ç»Ÿæ›´å¤šçš„æ˜¯å…è®¸åˆ†åŒºåå„å­ç³»ç»Ÿä¾ç„¶ä¿æŒ CA ã€‚
- CP without Aï¼šå¦‚æœä¸è¦æ±‚ Aï¼ˆå¯ç”¨ï¼‰ï¼Œç›¸å½“äºæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦åœ¨ Server ä¹‹é—´å¼ºä¸€è‡´ï¼Œè€Œ Pï¼ˆåˆ†åŒºï¼‰ä¼šå¯¼è‡´åŒæ­¥æ—¶é—´æ— é™å»¶é•¿ï¼Œå¦‚æ­¤ CP ä¹Ÿæ˜¯å¯ä»¥ä¿è¯çš„ã€‚å¾ˆå¤šä¼ ç»Ÿçš„æ•°æ®åº“åˆ†å¸ƒå¼äº‹åŠ¡éƒ½å±äºè¿™ç§æ¨¡å¼ã€‚
- AP wihtout Cï¼šè¦é«˜å¯ç”¨å¹¶å…è®¸åˆ†åŒºï¼Œåˆ™éœ€æ”¾å¼ƒä¸€è‡´æ€§ã€‚ä¸€æ—¦åˆ†åŒºå‘ç”Ÿï¼ŒèŠ‚ç‚¹ä¹‹é—´å¯èƒ½ä¼šå¤±å»è”ç³»ï¼Œä¸ºäº†é«˜å¯ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½ç”¨æœ¬åœ°æ•°æ®æä¾›æœåŠ¡ï¼Œè€Œè¿™æ ·ä¼šå¯¼è‡´å…¨å±€æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚ç°åœ¨ä¼—å¤šçš„NoSQLéƒ½å±äºæ­¤ç±»ã€‚

å¯èƒ½èƒ–å‹çœ‹å®Œä¹‹åï¼Œä¼šä¸€è„¸æ‡µé€¼ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºï¼ˆä¸€ï¼‰ï¼šCAP å®šç†ã€‹](https://my.oschina.net/lhztt/blog/915533) æ–‡ç« æä¾›çš„ç¤ºä¾‹ï¼š

- MySQL ä¸»ä»å¼‚æ­¥å¤åˆ¶æ˜¯ AP ç³»ç»Ÿã€‚
- MySQL ä¸»ä»åŠåŒæ­¥å¤åˆ¶æ˜¯ CP ç³»ç»Ÿã€‚
- Zookeeper æ˜¯ CP ç³»ç»Ÿã€‚
- Redis ä¸»ä»åŒæ­¥æ˜¯ AP ç³»ç»Ÿã€‚
- Eureka ä¸»ä»åŒæ­¥æ˜¯ AP ç³»ç»Ÿã€‚

ä»ä¸Šçš„ç¤ºä¾‹ä¸­ï¼Œ**â€œä¸‰é€‰äºŒâ€æ˜¯ä¸€ä¸ªä¼ªå‘½é¢˜**ã€‚ä¸æ˜¯ä¸ºäº† Pï¼ˆåˆ†åŒºå®¹å¿æ€§ï¼‰ï¼Œè¦åœ¨ A å’Œ C ä¹‹é—´é€‰æ‹©ä¸€ä¸ªã€‚åˆ†åŒºå¾ˆå°‘å‡ºç°ï¼ŒCAP åœ¨å¤§å¤šæ•°æ—¶å€™å…è®¸å®Œç¾çš„ C å’Œ A ã€‚ä½†å½“åˆ†åŒºå­˜åœ¨æˆ–å¯æ„ŸçŸ¥å…¶å½±å“çš„æƒ…å†µä¸‹ï¼Œå°±è¦é¢„å¤‡ä¸€ç§ç­–ç•¥å»æ¢çŸ¥åˆ†åŒºå¹¶æ˜¾å¼å¤„ç†å…¶å½±å“ã€‚

> è‰¿è‰¿ï¼Œå¦‚æœå…³äº**â€œä¸‰é€‰äºŒâ€æ˜¯ä¸€ä¸ªä¼ªå‘½é¢˜**æ— æ³•ç†è§£ï¼Œå¯ä»¥å›è¿‡å¤´åœ¨çœ‹ä¸€çœ¼â€œCA without Pâ€ ï¼Œå¯¹æ¯”ä¸‹å°±å¥½ç†è§£äº†ã€‚å¯¹äºå•èŠ‚ç‚¹ï¼ŒCA å¿…ç„¶æ˜¯å¯ä»¥ä¿è¯çš„ã€‚

å¦å¤–ï¼Œå…³äº CAP çš„è®ºè¯è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯è›®æœ‰è¶£çš„ä¸€å—å†…å®¹ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»æœç´¢ä¸‹ã€‚

ğŸ¦… **BASE ç†è®º**

BASE æ˜¯ Basically Available(åŸºæœ¬å¯ç”¨)ã€Soft state(è½¯çŠ¶æ€)å’Œ Eventually consistent (æœ€ç»ˆä¸€è‡´æ€§) ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ã€‚æ˜¯å¯¹ CAP ä¸­AP çš„ä¸€ä¸ªæ‰©å±•

1. BA åŸºæœ¬å¯ç”¨ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨åŠŸèƒ½ï¼Œä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨ã€‚
2. S è½¯çŠ¶æ€ï¼šå…è®¸ç³»ç»Ÿä¸­å­˜åœ¨ä¸­é—´çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ CAP ä¸­çš„ä¸ä¸€è‡´ã€‚
3. E æœ€ç»ˆä¸€è‡´ï¼šæœ€ç»ˆä¸€è‡´æ˜¯æŒ‡ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®éƒ½å°†ä¼šè¾¾åˆ°ä¸€è‡´ã€‚

BASE è§£å†³äº† CAP ä¸­ç†è®ºæ²¡æœ‰ç½‘ç»œå»¶è¿Ÿï¼Œåœ¨ BASE ä¸­ç”¨è½¯çŠ¶æ€å’Œæœ€ç»ˆä¸€è‡´ï¼Œä¿è¯äº†å»¶è¿Ÿåçš„ä¸€è‡´æ€§ã€‚

BASE å’Œ ACID æ˜¯ç›¸åçš„ï¼Œå®ƒå®Œå…¨ä¸åŒäº ACID çš„å¼ºä¸€è‡´æ€§æ¨¡å‹ï¼Œè€Œæ˜¯é€šè¿‡ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥è·å¾—å¯ç”¨æ€§ï¼Œå¹¶å…è®¸æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…æ˜¯ä¸ä¸€è‡´çš„ï¼Œä½†æœ€ç»ˆè¾¾åˆ°ä¸€è‡´çŠ¶æ€ã€‚

> å¯¹äºå¤§éƒ¨åˆ†çš„åˆ†å¸ƒå¼åº”ç”¨è€Œè¨€ï¼Œåªè¦æ•°æ®åœ¨è§„å®šçš„æ—¶é—´å†…è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§å³å¯ã€‚æˆ‘ä»¬å¯ä»¥æŠŠç¬¦åˆä¼ ç»Ÿçš„ ACID å«åšåˆšæ€§äº‹åŠ¡ï¼ŒæŠŠæ»¡è¶³ BASE ç†è®ºçš„æœ€ç»ˆä¸€è‡´æ€§äº‹åŠ¡å«åšæŸ”æ€§äº‹åŠ¡ã€‚
>
> ä¸€å‘³çš„è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼Œå¹¶éæœ€ä½³æ–¹æ¡ˆã€‚å¯¹äºåˆ†å¸ƒå¼åº”ç”¨æ¥è¯´ï¼ŒåˆšæŸ”å¹¶æµæ˜¯æ›´åŠ åˆç†çš„è®¾è®¡æ–¹æ¡ˆï¼Œå³åœ¨æœ¬åœ°æœåŠ¡ä¸­é‡‡ç”¨å¼ºä¸€è‡´äº‹åŠ¡ï¼Œåœ¨è·¨ç³»ç»Ÿè°ƒç”¨ä¸­é‡‡ç”¨æœ€ç»ˆä¸€è‡´æ€§ã€‚å¦‚ä½•æƒè¡¡ç³»ç»Ÿçš„æ€§èƒ½ä¸ä¸€è‡´æ€§ï¼Œæ˜¯ååˆ†è€ƒéªŒæ¶æ„å¸ˆä¸å¼€å‘è€…çš„è®¾è®¡åŠŸåŠ›çš„ã€‚

**å…·ä½“åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸Šï¼Œä¸šç•Œä¸»è¦é‡‡ç”¨äº† XA åè®®çš„å¼ºä¸€è‡´è§„èŒƒä»¥åŠæŸ”æ€§äº‹åŠ¡çš„æœ€ç»ˆä¸€è‡´è§„èŒƒ**ã€‚

> è‰¿è‰¿ï¼šæ‰€ä»¥ï¼Œå¸‚é¢ä¸Šçš„åˆ†å¸ƒå¼äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆï¼Œé™¤äº† XA åè®®æ˜¯å¼ºä¸€ç›´çš„ï¼Œå…¶ä»–éƒ½æ˜¯æœ€ç»ˆä¸€è‡´çš„ã€‚

## åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸»è¦æœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿ

åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸»è¦æœ‰ä»¥ä¸‹ 6 ç§æ–¹æ¡ˆï¼š

- XA æ–¹æ¡ˆ
- TCC æ–¹æ¡ˆ
- æœ¬åœ°æ¶ˆæ¯è¡¨
- å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ
- æœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆ
- SAGA

## èŠèŠ XA æ–¹æ¡ˆï¼Ÿ

XA æ˜¯ X/Open CAE Specification (Distributed Transaction Processing)æ¨¡å‹ï¼Œå®ƒå®šä¹‰çš„ TMï¼ˆTransaction Managerï¼‰ä¸ RMï¼ˆResource Managerï¼‰ä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ¥å£ã€‚

Javaä¸­ çš„ `javax.transaction.xa.XAResource` å®šä¹‰äº† XA æ¥å£ï¼Œå®ƒä¾èµ–æ•°æ®åº“å‚å•†å¯¹ jdbc-driver çš„å…·ä½“å®ç°ã€‚

- `mysql-connector-java-5.1.30` çš„å®ç°å¯å‚ `com.mysql.jdbc.jdbc2.optional.MysqlXAConnection` ç±»ã€‚

åœ¨ XA è§„èŒƒä¸­ï¼Œæ•°æ®åº“å……å½“ RM è§’è‰²ï¼Œåº”ç”¨éœ€è¦å……å½“ TM çš„è§’è‰²ï¼Œå³ç”Ÿæˆå…¨å±€çš„ txId ï¼Œè°ƒç”¨ XAResource æ¥å£ï¼ŒæŠŠå¤šä¸ªæœ¬åœ°äº‹åŠ¡åè°ƒä¸ºå…¨å±€ç»Ÿä¸€çš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

ç›®å‰ XA æœ‰ä¸¤ç§å®ç°ï¼š

- åŸºäºä¸€é˜¶æ®µæäº¤( 1PC ) çš„**å¼±** XA ã€‚
- åŸºäºäºŒé˜¶æ®µæäº¤( 2PC ) çš„**å¼º** XA ã€‚

### å¼± XA

![å¼± XA çš„é¡ºåºå›¾](http://static.iocoder.cn/fca74dec683cdea6b986652feec19958)

- å¼± XA é€šè¿‡å»æ‰ XA çš„ Prepare é˜¶æ®µï¼Œä»¥è¾¾åˆ°å‡å°‘èµ„æºé”å®šèŒƒå›´è€Œæå‡å¹¶å‘æ€§èƒ½çš„æ•ˆæœã€‚å…¸å‹çš„å®ç°ä¸ºåœ¨ä¸€ä¸ªä¸šåŠ¡çº¿ç¨‹ä¸­ï¼Œéå†æ‰€æœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œä¾æ¬¡åš commit æˆ–è€… rollback ã€‚
- å¼± XA åŒæœ¬åœ°äº‹åŠ¡ç›¸æ¯”ï¼Œæ€§èƒ½æŸè€—ä½ï¼Œä½†åœ¨äº‹åŠ¡æäº¤çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè‹¥å‡ºç°ç½‘ç»œæ•…éšœã€æ•°æ®åº“å®•æœºç­‰é¢„æœŸä¹‹å¤–çš„å¼‚å¸¸ï¼Œå°†ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´ï¼Œä¸”æ— æ³•è¿›è¡Œå›æ»šã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆï¼Ÿ**

åŸºäºå¼± XA çš„äº‹åŠ¡æ— éœ€é¢å¤–çš„å®ç°æˆæœ¬ï¼Œç›¸å¯¹å®¹æ˜“ã€‚ç›®å‰æ”¯æŒçš„æœ‰ï¼š

- MyCAT ï¼Œå…·ä½“çš„æºç è§£æï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠMyCAT æºç åˆ†æ â€”â€” XA åˆ†å¸ƒå¼äº‹åŠ¡ã€‹](http://www.iocoder.cn/MyCAT/xa-distributed-transaction/) ã€‚
- Sharding-Sphere é»˜è®¤æ”¯æŒã€‚

### å¼º XA

![å¼º XA çš„é¡ºåºå›¾](http://static.iocoder.cn/c8f27f0e1107c328476600c4ed2608ec)

- äºŒé˜¶æ®µæäº¤æ˜¯ XA çš„æ ‡å‡†å®ç°ã€‚å®ƒå°†åˆ†å¸ƒå¼äº‹åŠ¡çš„æäº¤æ‹†åˆ†ä¸º 2 ä¸ªé˜¶æ®µï¼šprepare å’Œ commit/rollback ã€‚
  - ç¬¬ä¸€é˜¶æ®µï¼šäº‹åŠ¡ç®¡ç†å™¨è¦æ±‚æ¯ä¸ªæ¶‰åŠåˆ°äº‹åŠ¡çš„æ•°æ®åº“é¢„æäº¤(precommit)æ­¤æ“ä½œï¼Œå¹¶åæ˜ æ˜¯å¦å¯ä»¥æäº¤ã€‚
  - ç¬¬äºŒé˜¶æ®µï¼šäº‹åŠ¡åè°ƒå™¨è¦æ±‚æ¯ä¸ªæ•°æ®åº“æäº¤æ•°æ®ï¼Œæˆ–è€…å›æ»šæ•°æ®ã€‚
- å¼€å¯ XA å…¨å±€äº‹åŠ¡åï¼Œæ‰€æœ‰å­äº‹åŠ¡ä¼šæŒ‰ç…§æœ¬åœ°é»˜è®¤çš„éš”ç¦»çº§åˆ«é”å®šèµ„æºï¼Œå¹¶è®°å½• undo å’Œ redo æ—¥å¿—ã€‚ç„¶åç”± TM å‘èµ· prepare æŠ•ç¥¨ï¼Œè¯¢é—®æ‰€æœ‰çš„å­äº‹åŠ¡æ˜¯å¦å¯ä»¥è¿›è¡Œæäº¤ï¼š
  - å½“æ‰€æœ‰å­äº‹åŠ¡åé¦ˆçš„ç»“æœä¸º â€œyesâ€ æ—¶ï¼ŒTM å†å‘èµ· commit ã€‚
  - è‹¥å…¶ä¸­ä»»ä½•ä¸€ä¸ªå­äº‹åŠ¡åé¦ˆçš„ç»“æœä¸ºâ€œnoâ€ï¼ŒTM åˆ™å‘èµ· rollback ã€‚
  - å¦‚æœåœ¨ prepare é˜¶æ®µçš„åé¦ˆç»“æœä¸º â€œyesâ€ ï¼Œè€Œ commit çš„è¿‡ç¨‹ä¸­å‡ºç°å®•æœºç­‰å¼‚å¸¸æ—¶ï¼Œåˆ™åœ¨èŠ‚ç‚¹æœåŠ¡é‡å¯åï¼Œå¯æ ¹æ® XA recover å†æ¬¡è¿›è¡Œ commit è¡¥å¿ï¼Œä»¥ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

ğŸ¦… **ä¼˜ç‚¹ï¼Ÿ**

- å°½é‡ä¿è¯äº†æ•°æ®çš„å¼ºä¸€è‡´ï¼Œå®ç°æˆæœ¬è¾ƒä½ï¼Œåœ¨å„å¤§ä¸»æµæ•°æ®åº“éƒ½æœ‰è‡ªå·±å®ç°ï¼Œå¯¹äº MySQL æ˜¯ä» 5.5 å¼€å§‹æ”¯æŒã€‚

ğŸ¦… **ç¼ºç‚¹ï¼Ÿ**

- å•ç‚¹é—®é¢˜ï¼šäº‹åŠ¡ç®¡ç†å™¨åœ¨æ•´ä¸ªæµç¨‹ä¸­æ‰®æ¼”çš„è§’è‰²å¾ˆå…³é”®ï¼Œå¦‚æœå…¶å®•æœºï¼Œæ¯”å¦‚åœ¨ç¬¬ä¸€é˜¶æ®µå·²ç»å®Œæˆï¼Œåœ¨ç¬¬äºŒé˜¶æ®µæ­£å‡†å¤‡æäº¤çš„æ—¶å€™äº‹åŠ¡ç®¡ç†å™¨å®•æœºï¼Œèµ„æºç®¡ç†å™¨å°±ä¼šä¸€ç›´é˜»å¡ï¼Œå¯¼è‡´æ•°æ®åº“æ— æ³•ä½¿ç”¨ã€‚

  > è‰¿è‰¿ï¼šå¦‚æœäº‹åŠ¡ç®¡ç†å™¨æ˜¯ Proxy æ¨¡å¼çš„æ•°æ®åº“ä¸­é—´ä»¶ï¼Œå¹¶ä¸”å®ç°é«˜å¯ç”¨ï¼Œå¯èƒ½å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä¸å¤ªè‚¯å®šï¼Œéœ€è¦åˆ°æ—¶ç¿»ä¸‹ Sharding Sphere çš„æºç ã€‚TODO

- åŒæ­¥é˜»å¡ï¼šåœ¨å‡†å¤‡å°±ç»ªä¹‹åï¼Œèµ„æºç®¡ç†å™¨ä¸­çš„èµ„æºä¸€ç›´å¤„äºé˜»å¡ï¼Œç›´åˆ°æäº¤å®Œæˆï¼Œé‡Šæ”¾èµ„æºã€‚

- æ•°æ®ä¸ä¸€è‡´ï¼šä¸¤é˜¶æ®µæäº¤åè®®è™½ç„¶ä¸ºåˆ†å¸ƒå¼æ•°æ®å¼ºä¸€è‡´æ€§æ‰€è®¾è®¡ï¼Œä½†ä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´æ€§çš„å¯èƒ½ï¼Œæ¯”å¦‚åœ¨ç¬¬äºŒé˜¶æ®µä¸­ï¼Œå‡è®¾åè°ƒè€…å‘å‡ºäº†äº‹åŠ¡commit çš„é€šçŸ¥ï¼Œä½†æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜è¯¥é€šçŸ¥ä»…è¢«ä¸€éƒ¨åˆ†å‚ä¸è€…æ‰€æ”¶åˆ°å¹¶æ‰§è¡Œäº† commit æ“ä½œï¼Œå…¶ä½™çš„å‚ä¸è€…åˆ™å› ä¸ºæ²¡æœ‰æ”¶åˆ°é€šçŸ¥ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œè¿™æ—¶å€™å°±äº§ç”Ÿäº†æ•°æ®çš„ä¸ä¸€è‡´æ€§ã€‚

  > è‰¿è‰¿ï¼šæ­¤å¤„çš„æ•°æ®ä¸ä¸€è‡´ä¹Ÿé—®é¢˜ä¸å¤§ï¼Œå› ä¸ºä½¿ç”¨ xa ä¼šé”å®šè®°å½•ï¼Œæ— æ³•è¢«è®¿é—®ã€‚

ğŸ¦… è§£å†³æ–¹æ¡ˆï¼Ÿ

- Sharding Sphere

  > Sharding Sphere æ”¯æŒåŸºäº XA çš„å¼ºä¸€è‡´æ€§äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é€šè¿‡ SPI æ³¨å…¥ä¸åŒçš„ç¬¬ä¸‰æ–¹ç»„ä»¶ä½œä¸ºäº‹åŠ¡ç®¡ç†å™¨å®ç° XA åè®®ï¼Œå¦‚ Atomikos å’Œ Narayana ã€‚

- [Spring JTA + Atomikos](https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-jta.html)

### åº”ç”¨åœºæ™¯

è¿™ç§åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆï¼Œæ¯”è¾ƒé€‚åˆå•å—åº”ç”¨é‡Œï¼Œè·¨å¤šä¸ªåº“çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè€Œä¸”å› ä¸ºä¸¥é‡ä¾èµ–äºæ•°æ®åº“å±‚é¢æ¥æå®šå¤æ‚çš„äº‹åŠ¡ï¼Œæ•ˆç‡å¾ˆä½ï¼Œç»å¯¹ä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯ã€‚

è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘ä»¬å¾ˆå°‘ç”¨ï¼Œä¸€èˆ¬æ¥è¯´**æŸä¸ªç³»ç»Ÿå†…éƒ¨å¦‚æœå‡ºç°è·¨å¤šä¸ªåº“**çš„è¿™ä¹ˆä¸€ä¸ªæ“ä½œï¼Œæ˜¯**ä¸åˆè§„**çš„ã€‚æˆ‘å¯ä»¥ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹ï¼Œ ç°åœ¨å¾®æœåŠ¡ï¼Œä¸€ä¸ªå¤§çš„ç³»ç»Ÿåˆ†æˆå‡ ç™¾ä¸ªæœåŠ¡ï¼Œå‡ åä¸ªæœåŠ¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬çš„è§„å®šå’Œè§„èŒƒï¼Œæ˜¯è¦æ±‚**æ¯ä¸ªæœåŠ¡åªèƒ½æ“ä½œè‡ªå·±å¯¹åº”çš„ä¸€ä¸ªæ•°æ®åº“**ã€‚

å¦‚æœä½ è¦æ“ä½œåˆ«çš„æœåŠ¡å¯¹åº”çš„åº“ï¼Œä¸å…è®¸ç›´è¿åˆ«çš„æœåŠ¡çš„åº“ï¼Œè¿åå¾®æœåŠ¡æ¶æ„çš„è§„èŒƒï¼Œä½ éšä¾¿äº¤å‰èƒ¡ä¹±è®¿é—®ï¼Œå‡ ç™¾ä¸ªæœåŠ¡çš„è¯ï¼Œå…¨ä½“ä¹±å¥—ï¼Œè¿™æ ·çš„ä¸€å¥—æœåŠ¡æ˜¯æ²¡æ³•ç®¡ç†çš„ï¼Œæ²¡æ³•æ²»ç†çš„ï¼Œå¯èƒ½ä¼šå‡ºç°æ•°æ®è¢«åˆ«äººæ”¹é”™ï¼Œè‡ªå·±çš„åº“è¢«åˆ«äººå†™æŒ‚ç­‰æƒ…å†µã€‚

å¦‚æœä½ è¦æ“ä½œåˆ«äººçš„æœåŠ¡çš„åº“ï¼Œä½ å¿…é¡»æ˜¯é€šè¿‡**è°ƒç”¨åˆ«çš„æœåŠ¡çš„æ¥å£**æ¥å®ç°ï¼Œç»å¯¹ä¸å…è®¸äº¤å‰è®¿é—®åˆ«äººçš„æ•°æ®åº“ã€‚

![distributed-transacion-XA](http://static.iocoder.cn/baef17d9dde837632e9a7894cb825cb2)

## èŠèŠ TCC æ–¹æ¡ˆï¼Ÿ

TCC æ¨¡å‹æ˜¯æŠŠé”çš„ç²’åº¦å®Œå…¨äº¤ç»™ä¸šåŠ¡å¤„ç†ï¼Œå®ƒéœ€è¦æ¯ä¸ªå­äº‹åŠ¡ä¸šåŠ¡éƒ½å®ç°Try-Confirm / Cancel æ¥å£ã€‚

> TCC æ¨¡å¼æœ¬è´¨ä¹Ÿæ˜¯ 2PC ï¼Œåªæ˜¯ TCC åœ¨åº”ç”¨å±‚æ§åˆ¶ã€‚

- Try:
  - å°è¯•æ‰§è¡Œä¸šåŠ¡
  - å®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼ˆä¸€è‡´æ€§ï¼‰
  - é¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æºï¼ˆå‡†éš”ç¦»æ€§ï¼‰
- Confirm:
  - ç¡®è®¤æ‰§è¡Œä¸šåŠ¡ï¼›
  - çœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œä¸ä½œä»»ä½•ä¸šåŠ¡æ£€æŸ¥
  - åªä½¿ç”¨Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº
  - Confirm æ“ä½œæ»¡è¶³å¹‚ç­‰æ€§

- Cancel:
  - å–æ¶ˆæ‰§è¡Œä¸šåŠ¡
  - é‡Šæ”¾Tryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº
  - Cancelæ“ä½œæ»¡è¶³å¹‚ç­‰æ€§

è¿™ä¸‰ä¸ªé˜¶æ®µï¼Œéƒ½ä¼šæŒ‰æœ¬åœ°äº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œã€‚ä¸åŒäº XAçš„prepare ï¼ŒTCC æ— éœ€å°† XA çš„æŠ•ç¥¨æœŸé—´çš„æ‰€æœ‰èµ„æºæŒ‚èµ·ï¼Œå› æ­¤æå¤§çš„æé«˜äº†ååé‡ã€‚

ğŸ¦… **åº”ç”¨åœºæ™¯**

ä¸‹é¢å¯¹TCCæ¨¡å¼ä¸‹ï¼ŒAè´¦æˆ·å¾€Bè´¦æˆ·æ±‡æ¬¾100å…ƒä¸ºä¾‹å­ï¼Œå¯¹ä¸šåŠ¡çš„æ”¹é€ è¿›è¡Œè¯¦ç»†çš„åˆ†æï¼š

![img](http://static.iocoder.cn/4da5bc0df774ef90e97c6358eb7e632f)

- æ±‡æ¬¾æœåŠ¡å’Œæ”¶æ¬¾æœåŠ¡åˆ†åˆ«éœ€è¦å®ç°ï¼ŒTry-Confirm-Cancel æ¥å£ï¼Œå¹¶åœ¨ä¸šåŠ¡åˆå§‹åŒ–é˜¶æ®µå°†å…¶æ³¨å…¥åˆ° TCC äº‹åŠ¡ç®¡ç†å™¨ä¸­ã€‚

æ±‡æ¬¾æœåŠ¡

- Tryï¼š
  - æ£€æŸ¥Aè´¦æˆ·æœ‰æ•ˆæ€§ï¼Œå³æŸ¥çœ‹Aè´¦æˆ·çš„çŠ¶æ€æ˜¯å¦ä¸ºâ€œè½¬å¸ä¸­â€æˆ–è€…â€œå†»ç»“â€
  - æ£€æŸ¥Aè´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³
  - ä»Aè´¦æˆ·ä¸­æ‰£å‡ 100 å…ƒï¼Œå¹¶å°†çŠ¶æ€ç½®ä¸ºâ€œè½¬è´¦ä¸­â€
  - é¢„ç•™æ‰£å‡èµ„æºï¼Œå°†ä» A å¾€ B è´¦æˆ·è½¬è´¦ 100 å…ƒè¿™ä¸ªäº‹ä»¶å­˜å…¥æ¶ˆæ¯æˆ–è€…æ—¥å¿—ä¸­
- Confirmï¼š
  - ä¸åšä»»ä½•æ“ä½œ
- Cancelï¼š
  - A è´¦æˆ·å¢åŠ  100 å…ƒ
  - ä»æ—¥å¿—æˆ–è€…æ¶ˆæ¯ä¸­ï¼Œé‡Šæ”¾æ‰£å‡èµ„æº

æ”¶æ¬¾æœåŠ¡

- Tryï¼š
  - æ£€æŸ¥ B è´¦æˆ·è´¦æˆ·æ˜¯å¦æœ‰æ•ˆï¼›
- Confirmï¼š
  - è¯»å–æ—¥å¿—æˆ–è€…æ¶ˆæ¯ï¼ŒB è´¦æˆ·å¢åŠ  100 å…ƒ
  - ä»æ—¥å¿—æˆ–è€…æ¶ˆæ¯ä¸­ï¼Œé‡Šæ”¾æ‰£å‡èµ„æºï¼›
- Cancelï¼š
  - ä¸åšä»»ä½•æ“ä½œ

ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼ŒTCC æ¨¡å‹å¯¹ä¸šåŠ¡çš„ä¾µå…¥å¼ºï¼Œæ”¹é€ çš„éš¾åº¦å¤§ã€‚

ä½†æ˜¯ï¼Œåœ¨éœ€è¦å‰ç½®èµ„æºé”å®šçš„åœºæ™¯ï¼Œä¸å¾—ä¸ä½¿ç”¨ XA æˆ– TCC çš„æ–¹å¼ã€‚å†ä¾‹å¦‚è¯´ï¼Œä¸‹å•åœºæ™¯ï¼Œåœ¨è®¢å•åˆ›å»ºä¹‹å‰ï¼Œéœ€è¦æ‰£é™¤å¦‚ä¸‹å‡ ä¸ªèµ„æºï¼š

- ä¼˜æƒ åŠµ
- é’±åŒ…ä½™é¢
- ç§¯åˆ†
- â€¦.

é‚£ä¹ˆï¼Œä¸å¾—ä¸è¿›è¡Œå‰ç½®å¤šèµ„æºé”å®šï¼Œæ— éæ˜¯ä½¿ç”¨ XA çš„å¼ºé”ï¼Œè¿˜æ˜¯ TCC çš„å¼±é”ã€‚åœ¨ [oceans](https://github.com/YunaiV/oceans/tree/0.0.1) çš„ tag `0.0.1` ä¸­ï¼Œåœ¨æœªä½¿ç”¨ TCC çš„æƒ…å†µä¸‹ï¼Œæ¨¡æ‹Ÿ TCC çš„æ•ˆæœçš„è‹¦é—·ã€‚

å½“ç„¶ï¼Œå¦‚æœèƒ½ä¸ç”¨ TCC çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸è¦ç”¨ TCC ã€‚å› ä¸ºï¼Œç¼–å†™å›æ»šé€»è¾‘çš„ä»£ç ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒæ¶å¿ƒã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆï¼Ÿ**

- TCC-Transaction ï¼Œå¬è¯´å–œé©¬æ‹‰é›…åœ¨ç”¨ã€‚å…·ä½“çš„æºç è§£æï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠTCC-Transaction æºç åˆ†æã€‹](http://www.iocoder.cn/categories/TCC-Transaction/) ã€‚
- Hmily ï¼Œå…·ä½“çš„æºç è§£æï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠHmily å®ç°åŸç†ä¸æºç è§£æç³»åˆ— â€”â€” ç²¾å“åˆé›†ã€‹](http://www.iocoder.cn/Hmily/good-collection/) ã€‚
- ByteTCC

## èŠèŠæœ¬åœ°æ¶ˆæ¯è¡¨ï¼Ÿ

æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œå…¶å®æ˜¯ [å›½å¤–çš„ Ebay æå‡ºæ¥çš„è¿™ä¹ˆä¸€å¥—æ€æƒ³](https://queue.acm.org/detail.cfm?id=1394128) ã€‚

è¿™ä¸ªå¤§æ¦‚æ„æ€æ˜¯è¿™æ ·çš„ï¼š

![distributed-transaction-local-message-table](http://static.iocoder.cn/b1fc3558543e402cb373792eade99e0f)

1. A ç³»ç»Ÿåœ¨è‡ªå·±æœ¬åœ°ä¸€ä¸ªäº‹åŠ¡é‡Œæ“ä½œåŒæ—¶ï¼Œæ’å…¥ä¸€æ¡æ•°æ®åˆ°æ¶ˆæ¯è¡¨ï¼›
2. æ¥ç€ A ç³»ç»Ÿå°†è¿™ä¸ªæ¶ˆæ¯å‘é€åˆ° MQ ä¸­å»ï¼›
3. B ç³»ç»Ÿæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œåœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œå¾€è‡ªå·±æœ¬åœ°æ¶ˆæ¯è¡¨é‡Œæ’å…¥ä¸€æ¡æ•°æ®ï¼ŒåŒæ—¶æ‰§è¡Œå…¶ä»–çš„ä¸šåŠ¡æ“ä½œï¼Œå¦‚æœè¿™ä¸ªæ¶ˆæ¯å·²ç»è¢«å¤„ç†è¿‡äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™ä¸ªäº‹åŠ¡ä¼šå›æ»šï¼Œè¿™æ ·**ä¿è¯ä¸ä¼šé‡å¤å¤„ç†æ¶ˆæ¯**ï¼›
4. B ç³»ç»Ÿæ‰§è¡ŒæˆåŠŸä¹‹åï¼Œå°±ä¼šæ›´æ–°è‡ªå·±æœ¬åœ°æ¶ˆæ¯è¡¨çš„çŠ¶æ€ä»¥åŠ A ç³»ç»Ÿæ¶ˆæ¯è¡¨çš„çŠ¶æ€ï¼›
5. å¦‚æœ B ç³»ç»Ÿå¤„ç†å¤±è´¥äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæ›´æ–°æ¶ˆæ¯è¡¨çŠ¶æ€ï¼Œé‚£ä¹ˆæ­¤æ—¶ A ç³»ç»Ÿä¼šå®šæ—¶æ‰«æè‡ªå·±çš„æ¶ˆæ¯è¡¨ï¼Œå¦‚æœæœ‰æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œä¼šå†æ¬¡å‘é€åˆ° MQ ä¸­å»ï¼Œè®© B å†æ¬¡å¤„ç†ï¼›
6. è¿™ä¸ªæ–¹æ¡ˆä¿è¯äº†æœ€ç»ˆä¸€è‡´æ€§ï¼Œå“ªæ€• B äº‹åŠ¡å¤±è´¥äº†ï¼Œä½†æ˜¯ A ä¼šä¸æ–­é‡å‘æ¶ˆæ¯ï¼Œç›´åˆ° B é‚£è¾¹æˆåŠŸä¸ºæ­¢ã€‚

è¿™ä¸ªæ–¹æ¡ˆè¯´å®è¯æœ€å¤§çš„é—®é¢˜å°±åœ¨äº**ä¸¥é‡ä¾èµ–äºæ•°æ®åº“çš„æ¶ˆæ¯è¡¨æ¥ç®¡ç†äº‹åŠ¡**å•¥çš„ï¼Œä¼šå¯¼è‡´å¦‚æœæ˜¯é«˜å¹¶å‘åœºæ™¯å’‹åŠå‘¢ï¼Ÿå’‹æ‰©å±•å‘¢ï¼Ÿæ‰€ä»¥ä¸€èˆ¬ç¡®å®å¾ˆå°‘ç”¨ã€‚

æœ¬åœ°æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ BASE ç†è®ºï¼Œæ˜¯æœ€ç»ˆä¸€è‡´æ¨¡å‹ï¼Œé€‚ç”¨äºå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„ã€‚å®ç°è¿™ä¸ªæ¨¡å‹æ—¶éœ€è¦æ³¨æ„é‡è¯•çš„å¹‚ç­‰ã€‚

## èŠèŠå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼Ÿ

è¿™ä¸ªçš„æ„æ€ï¼Œå°±æ˜¯å¹²è„†ä¸è¦ç”¨æœ¬åœ°çš„æ¶ˆæ¯è¡¨äº†ï¼Œç›´æ¥åŸºäº MQ æ¥å®ç°äº‹åŠ¡ã€‚æ¯”å¦‚é˜¿é‡Œçš„ RocketMQ å°±æ”¯æŒæ¶ˆæ¯äº‹åŠ¡ã€‚

å¤§æ¦‚çš„æ„æ€å°±æ˜¯ï¼š

![distributed-transaction-reliable-message](http://static.iocoder.cn/80a431c9be51ed67d9c67f7a1de7c2ed)

1. A ç³»ç»Ÿå…ˆå‘é€ä¸€ä¸ª prepared æ¶ˆæ¯åˆ° mqï¼Œå¦‚æœè¿™ä¸ª prepared æ¶ˆæ¯å‘é€å¤±è´¥é‚£ä¹ˆå°±ç›´æ¥å–æ¶ˆæ“ä½œåˆ«æ‰§è¡Œäº†ï¼›
2. å¦‚æœè¿™ä¸ªæ¶ˆæ¯å‘é€æˆåŠŸè¿‡äº†ï¼Œé‚£ä¹ˆæ¥ç€æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå¦‚æœæˆåŠŸå°±å‘Šè¯‰ mq å‘é€ç¡®è®¤æ¶ˆæ¯ï¼Œå¦‚æœå¤±è´¥å°±å‘Šè¯‰ mq å›æ»šæ¶ˆæ¯ï¼›
3. å¦‚æœå‘é€äº†ç¡®è®¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ­¤æ—¶ B ç³»ç»Ÿä¼šæ¥æ”¶åˆ°ç¡®è®¤æ¶ˆæ¯ï¼Œç„¶åæ‰§è¡Œæœ¬åœ°çš„äº‹åŠ¡ï¼›
4. mq ä¼šè‡ªåŠ¨**å®šæ—¶è½®è¯¢**æ‰€æœ‰ prepared æ¶ˆæ¯å›è°ƒä½ çš„æ¥å£ï¼Œé—®ä½ ï¼Œè¿™ä¸ªæ¶ˆæ¯æ˜¯ä¸æ˜¯æœ¬åœ°äº‹åŠ¡å¤„ç†å¤±è´¥äº†ï¼Œæ‰€æœ‰æ²¡å‘é€ç¡®è®¤çš„æ¶ˆæ¯ï¼Œæ˜¯ç»§ç»­é‡è¯•è¿˜æ˜¯å›æ»šï¼Ÿä¸€èˆ¬æ¥è¯´è¿™é‡Œä½ å°±å¯ä»¥æŸ¥ä¸‹æ•°æ®åº“çœ‹ä¹‹å‰æœ¬åœ°äº‹åŠ¡æ˜¯å¦æ‰§è¡Œï¼Œå¦‚æœå›æ»šäº†ï¼Œé‚£ä¹ˆè¿™é‡Œä¹Ÿå›æ»šå§ã€‚è¿™ä¸ªå°±æ˜¯é¿å…å¯èƒ½æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸäº†ï¼Œè€Œç¡®è®¤æ¶ˆæ¯å´å‘é€å¤±è´¥äº†ã€‚
5. è¿™ä¸ªæ–¹æ¡ˆé‡Œï¼Œè¦æ˜¯ç³»ç»Ÿ B çš„äº‹åŠ¡å¤±è´¥äº†å’‹åŠï¼Ÿé‡è¯•å’¯ï¼Œè‡ªåŠ¨ä¸æ–­é‡è¯•ç›´åˆ°æˆåŠŸï¼Œå¦‚æœå®åœ¨æ˜¯ä¸è¡Œï¼Œè¦ä¹ˆå°±æ˜¯é’ˆå¯¹é‡è¦çš„èµ„é‡‘ç±»ä¸šåŠ¡è¿›è¡Œå›æ»šï¼Œæ¯”å¦‚ B ç³»ç»Ÿæœ¬åœ°å›æ»šåï¼Œæƒ³åŠæ³•é€šçŸ¥ç³»ç»Ÿ A ä¹Ÿå›æ»šï¼›æˆ–è€…æ˜¯å‘é€æŠ¥è­¦ç”±äººå·¥æ¥æ‰‹å·¥å›æ»šå’Œè¡¥å¿ã€‚

**è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œç›®å‰å›½å†…äº’è”ç½‘å…¬å¸å¤§éƒ½æ˜¯è¿™ä¹ˆç©å„¿çš„**ã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆ**

- RocketMQ äº‹åŠ¡æ¶ˆæ¯ï¼Œæºç è§£æï¼Œå¯è§ [ã€ŠRocketMQ æºç åˆ†æ â€”â€” äº‹åŠ¡æ¶ˆæ¯ã€‹](http://www.iocoder.cn/RocketMQ/message-transaction/?vip) ã€‚

  > è™½ç„¶ RocketMQ æ—©æœŸå¼€æºäº‹åŠ¡æ¶ˆæ¯ååˆé˜‰å‰²é—­æºï¼Œä½†æ˜¯åœ¨ RocketMQ 4.3 ç‰ˆæœ¬ä¸­ï¼Œåˆé‡æ–°æä¾›ã€‚æ‰€ä»¥ï¼Œä¸è¦æé”™è½ã€‚

- [ã€ŠRabbitMQ ä¹‹æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆäº‹åŠ¡+Confirmï¼‰ã€‹](https://blog.csdn.net/u013256816/article/details/55515234)

- Kafka äº‹åŠ¡æ¶ˆæ¯ï¼Œ<https://zhuanlan.zhihu.com/p/42046847> TODO éœ€è¦æ‰¾å®å¤§ç¡®è®¤ä¸‹

## èŠèŠæœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆï¼Ÿ

è‰¿è‰¿ç…äº†ç…å¸‚é¢ä¸Šçš„èµ„æ–™ï¼Œåˆ†åˆ«æœ‰ä¸¤ç§è§£é‡Šã€‚æˆ–è€…è¯´ï¼Œä¸¤ç§ä¸åŒçš„è§£å†³æ–¹æ¡ˆã€‚

### è§£é‡Šä¸€

æœ€å¤§åŠªåŠ›é€è¾¾ï¼Œæ˜¯é’ˆå¯¹äºå¼± XA çš„ä¸€ç§è¡¥å¿ç­–ç•¥ã€‚å®ƒé‡‡ç”¨äº‹åŠ¡è¡¨è®°å½•æ‰€æœ‰çš„äº‹åŠ¡æ“ä½œ SQL ã€‚

![img](http://static.iocoder.cn/728bf44f14926be91f33c4c7fda15fad)

- å¦‚æœå­äº‹åŠ¡æäº¤æˆåŠŸï¼Œå°†ä¼šåˆ é™¤äº‹åŠ¡æ—¥å¿—ã€‚
- å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œåˆ™ä¼šæŒ‰ç…§é…ç½®çš„é‡è¯•æ¬¡æ•°ï¼Œå°è¯•å†æ¬¡æäº¤ï¼Œå³æœ€å¤§åŠªåŠ›çš„è¿›è¡Œæäº¤ï¼Œå°½é‡ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œå¹³è¡¡ C å’Œ A ï¼Œé‡‡ç”¨åŒæ­¥é‡è¯•æˆ–å¼‚æ­¥é‡è¯•ã€‚

ğŸ¦… **ä¼˜ç‚¹**

- æ— é”å®šèµ„æºæ—¶é—´ï¼Œæ€§èƒ½æŸè€—å°ã€‚

ğŸ¦… **ç¼ºç‚¹**

- å°è¯•å¤šæ¬¡æäº¤å¤±è´¥åï¼Œæ— æ³•å›æ»šï¼Œå®ƒä»…é€‚ç”¨äºäº‹åŠ¡æœ€ç»ˆä¸€å®šèƒ½å¤ŸæˆåŠŸçš„ä¸šåŠ¡åœºæ™¯ã€‚

ğŸ¦… **æ€»ç»“**

- å› æ­¤ BED æ˜¯é€šè¿‡äº‹åŠ¡å›æ»šåŠŸèƒ½ä¸Šçš„å¦¥åï¼Œæ¥æ¢å–æ€§èƒ½çš„æå‡ã€‚

è²Œä¼¼ï¼Œæš‚æ—¶ä¹Ÿæƒ³è±¡ä¸åˆ°å…·ä½“çš„ä½¿ç”¨åœºæ™¯ã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆ**

æ­£å¦‚ä¸Šå›¾ï¼Œæä¾›çš„è§£å†³æ–¹å¼ Sharding-JDBC ï¼Œå…·ä½“çš„æºç è§£æï¼Œå¯è§ [ã€ŠSharding-JDBC æºç åˆ†æ â€”â€” åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆä¸€ï¼‰ä¹‹æœ€å¤§åŠªåŠ›å‹ã€‹](http://www.iocoder.cn/Sharding-JDBC/transaction-bed/?vip) ã€‚

### è§£é‡ŠäºŒ

è¿™ä¸ªæ–¹æ¡ˆçš„å¤§è‡´æ„æ€å°±æ˜¯ï¼š

1. ç³»ç»Ÿ A æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå®Œä¹‹åï¼Œå‘é€ä¸ªæ¶ˆæ¯åˆ° MQï¼›
2. è¿™é‡Œä¼šæœ‰ä¸ªä¸“é—¨æ¶ˆè´¹ MQ çš„**æœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡**ï¼Œè¿™ä¸ªæœåŠ¡ä¼šæ¶ˆè´¹ MQ ç„¶åå†™å…¥æ•°æ®åº“ä¸­è®°å½•ä¸‹æ¥ï¼Œæˆ–è€…æ˜¯æ”¾å…¥ä¸ªå†…å­˜é˜Ÿåˆ—ä¹Ÿå¯ä»¥ï¼Œæ¥ç€è°ƒç”¨ç³»ç»Ÿ B çš„æ¥å£ï¼›
3. è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡ŒæˆåŠŸå°± ok äº†ï¼›è¦æ˜¯ç³»ç»Ÿ B æ‰§è¡Œå¤±è´¥äº†ï¼Œé‚£ä¹ˆæœ€å¤§åŠªåŠ›é€šçŸ¥æœåŠ¡å°±å®šæ—¶å°è¯•é‡æ–°è°ƒç”¨ç³»ç»Ÿ Bï¼Œåå¤ N æ¬¡ï¼Œæœ€åè¿˜æ˜¯ä¸è¡Œå°±æ”¾å¼ƒã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆ**

æŒ‰ç…§è¿™ä¸ªè§£é‡Šï¼ŒRocketMQ çš„æ¶ˆæ¯é‡è¯•ï¼Œç¬¦åˆè¿™ä¸ªè§£é‡Šã€‚å…·ä½“çš„æºç è§£æï¼Œè§ [ã€ŠRocketMQ æºç åˆ†æ â€”â€” å®šæ—¶æ¶ˆæ¯ä¸æ¶ˆæ¯é‡è¯•ã€‹](http://www.iocoder.cn/RocketMQ/message-schedule-and-retry/) ã€‚

æ¯”è¾ƒå¸¸è§çš„åœºæ™¯ï¼Œå°±æ˜¯æ”¯ä»˜æˆåŠŸåï¼Œå¤šæ¬¡å›è°ƒ~

## èŠèŠ Saga æ–¹æ¡ˆï¼Ÿ

Saga æ˜¯ 30 å¹´å‰ä¸€ç¯‡æ•°æ®åº“ä¼¦ç†æåˆ°çš„ä¸€ä¸ªæ¦‚å¿µã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡ï¼Œç”± Saga äº‹åŠ¡åè°ƒå™¨åè°ƒï¼Œå¦‚æœæ­£å¸¸ç»“æŸé‚£å°±æ­£å¸¸å®Œæˆï¼Œå¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™æ ¹æ®ç›¸åé¡ºåºä¸€æ¬¡è°ƒç”¨è¡¥å¿æ“ä½œã€‚

Saga çš„ç»„æˆå¦‚ä¸‹ï¼š

- æ¯ä¸ª Saga ç”±ä¸€ç³»åˆ— sub-transaction Ti ç»„æˆ
- æ¯ä¸ªTi éƒ½æœ‰å¯¹åº”çš„è¡¥å¿åŠ¨ä½œ Ci ï¼Œè¡¥å¿åŠ¨ä½œç”¨äºæ’¤é”€ Ti é€ æˆçš„ç»“æœã€‚è¿™é‡Œçš„æ¯ä¸ª T ï¼Œéƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ã€‚
- å¯ä»¥çœ‹åˆ°ï¼Œå’Œ TCC ç›¸æ¯”ï¼ŒSaga æ²¡æœ‰â€œé¢„ç•™ tryâ€åŠ¨ä½œ ï¼Œå®ƒçš„ Ti å°±æ˜¯ç›´æ¥æäº¤åˆ°åº“ã€‚

Sagaçš„æ‰§è¡Œé¡ºåºæœ‰ä¸¤ç§ï¼š

- å­äº‹åŠ¡åºåˆ— T1, T2, â€¦, Tnå¾—ä»¥å®Œæˆ (æœ€ä½³æƒ…å†µ)ã€‚
- æˆ–è€…åºåˆ— T1, T2, â€¦, Tj, Cj, â€¦, C2, C1, 0 < j < n, å¾—ä»¥å®Œæˆã€‚

Saga å®šä¹‰äº†ä¸¤ç§æ¢å¤ç­–ç•¥ï¼š

- å‘åæ¢å¤ï¼šè¡¥å¿æ‰€æœ‰å·²å®Œæˆçš„äº‹åŠ¡ï¼Œå¦‚æœä»»ä¸€å­äº‹åŠ¡å¤±è´¥ã€‚

  > å‘åæ¢å¤ï¼Œå³ä¸Šé¢æåˆ°çš„ç¬¬äºŒç§æ‰§è¡Œé¡ºåºï¼Œå…¶ä¸­ j æ˜¯å‘ç”Ÿé”™è¯¯çš„ sub-transaction ï¼Œè¿™ç§åšæ³•çš„æ•ˆæœæ˜¯æ’¤é”€æ‰ä¹‹å‰æ‰€æœ‰æˆåŠŸçš„ sub-transation ï¼Œä½¿å¾—æ•´ä¸ª Saga çš„æ‰§è¡Œç»“æœæ’¤é”€ã€‚

- å‘å‰æ¢å¤ï¼šé‡è¯•å¤±è´¥çš„äº‹åŠ¡ï¼Œå‡è®¾æ¯ä¸ªå­äº‹åŠ¡æœ€ç»ˆéƒ½ä¼šæˆåŠŸã€‚

  > æ˜¾ç„¶ï¼Œå‘å‰æ¢å¤æ²¡æœ‰å¿…è¦æä¾›è¡¥å¿äº‹åŠ¡ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡ä¸­ï¼Œå­äº‹åŠ¡ï¼ˆæœ€ç»ˆï¼‰æ€»ä¼šæˆåŠŸï¼Œæˆ–è¡¥å¿äº‹åŠ¡éš¾ä»¥å®šä¹‰æˆ–ä¸å¯èƒ½ï¼Œå‘å‰æ¢å¤æ›´ç¬¦åˆä½ çš„éœ€æ±‚ã€‚ç†è®ºä¸Šè¡¥å¿äº‹åŠ¡æ°¸ä¸å¤±è´¥ï¼Œç„¶è€Œï¼Œåœ¨åˆ†å¸ƒå¼ä¸–ç•Œä¸­ï¼ŒæœåŠ¡å™¨å¯èƒ½ä¼šå®•æœºã€ç½‘ç»œå¯èƒ½ä¼šå¤±è´¥ï¼Œç”šè‡³æ•°æ®ä¸­å¿ƒä¹Ÿå¯èƒ½ä¼šåœç”µï¼Œè¿™æ—¶éœ€è¦æä¾›æ•…éšœæ¢å¤åå›é€€çš„æœºåˆ¶ï¼Œæ¯”å¦‚äººå·¥å¹²é¢„ã€‚

ğŸ¦… **å¦‚ä½•è§£å†³æ²¡æœ‰ Prepareé˜¶æ®µå¯èƒ½å¸¦æ¥çš„é—®é¢˜ï¼Ÿ**

ç”±äº Saga æ¨¡å‹ä¸­æ²¡æœ‰ Prepare é˜¶æ®µï¼Œå› æ­¤äº‹åŠ¡é—´ä¸èƒ½ä¿è¯éš”ç¦»æ€§ï¼Œå½“å¤šä¸ª Saga äº‹åŠ¡æ“ä½œåŒä¸€èµ„æºæ—¶ï¼Œå°±ä¼šäº§ç”Ÿæ›´æ–°ä¸¢å¤±ã€è„æ•°æ®è¯»å–ç­‰é—®é¢˜ï¼Œè¿™æ—¶éœ€è¦åœ¨ä¸šåŠ¡å±‚æ§åˆ¶å¹¶å‘ã€‚ä¾‹å¦‚ï¼š

- åœ¨åº”ç”¨å±‚é¢åŠ é”ã€‚
- åº”ç”¨å±‚é¢é¢„å…ˆå†»ç»“èµ„æºã€‚

è¿˜æ˜¯æ‹¿ 100 å…ƒä¹°ä¸€ç“¶æ°´çš„ä¾‹å­æ¥è¯´ã€‚

- è¿™é‡Œå®šä¹‰ï¼š

  - T1=æ‰£100å…ƒ T2=ç»™ç”¨æˆ·åŠ ä¸€ç“¶æ°´ T3=å‡åº“å­˜ä¸€ç“¶æ°´
  - C1=åŠ 100å…ƒ C2=ç»™ç”¨æˆ·å‡ä¸€ç“¶æ°´ C3=ç»™åº“å­˜åŠ ä¸€ç“¶æ°´

- æˆ‘ä»¬ä¸€æ¬¡è¿›è¡Œ T1ï¼ŒT2ï¼ŒT3ã€‚å¦‚æœå‘ç”Ÿé—®é¢˜ï¼Œå°±æ‰§è¡Œå‘ç”Ÿé—®é¢˜çš„ C æ“ä½œçš„åå‘ã€‚ä¸Šé¢è¯´åˆ°çš„éš”ç¦»æ€§çš„é—®é¢˜ä¼šå‡ºç°åœ¨ï¼Œå¦‚æœæ‰§è¡Œåˆ° T3 è¿™ä¸ªæ—¶å€™éœ€è¦æ‰§è¡Œå›æ»šï¼Œä½†æ˜¯è¿™ä¸ªç”¨æˆ·å·²ç»æŠŠæ°´å–äº†(**å¦å¤–ä¸€ä¸ªäº‹åŠ¡**)ï¼Œå›æ»šçš„æ—¶å€™å°±ä¼šå‘ç°ï¼Œæ— æ³•ç»™ç”¨æˆ·å‡ä¸€ç“¶æ°´äº†ã€‚è¿™å°±æ˜¯äº‹åŠ¡ä¹‹é—´æ²¡æœ‰éš”ç¦»æ€§çš„é—®é¢˜ã€‚

  > è‰¿è‰¿ï¼šä¹Ÿå°±æ˜¯è¯´ï¼Œç»™çš„å¤ªæ—©ï¼Œä½†æ˜¯å¯ä»¥è¢«å–æ¶ˆï¼

å¯ä»¥çœ‹è§ Saga æ¨¡å¼æ²¡æœ‰éš”ç¦»æ€§çš„å½±å“è¿˜æ˜¯è¾ƒå¤§ï¼Œå¯ä»¥å‚ç…§åä¸ºçš„è§£å†³æ–¹æ¡ˆ:

- ä»ä¸šåŠ¡å±‚é¢å…¥æ‰‹åŠ å…¥ä¸€ Session ä»¥åŠé”çš„æœºåˆ¶æ¥ä¿è¯èƒ½å¤Ÿä¸²è¡ŒåŒ–æ“ä½œèµ„æºã€‚
- ä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡å±‚é¢é€šè¿‡é¢„å…ˆå†»ç»“èµ„é‡‘çš„æ–¹å¼éš”ç¦»è¿™éƒ¨åˆ†èµ„æºï¼Œæœ€ååœ¨ä¸šåŠ¡æ“ä½œçš„è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡åŠæ—¶è¯»å–å½“å‰çŠ¶æ€çš„æ–¹å¼è·å–åˆ°æœ€æ–°çš„æ›´æ–°ã€‚

ğŸ¦… **è§£å†³æ–¹æ¡ˆ**

- Apache Service Comb çš„ Saga äº‹åŠ¡å¼•æ“

- Sharding Sphere çš„ Saga æ”¯æŒ

  > å®é™…æ˜¯åŸºäº Apache Service Comb çš„ Saga äº‹åŠ¡å¼•æ“ä¹‹ä¸Šè¿›è¡Œå¼€å‘ã€‚

## ä½ ä»¬å…¬å¸æ˜¯å¦‚ä½•å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Ÿ

å¦‚æœä½ çœŸçš„è¢«é—®åˆ°ï¼Œå¯ä»¥è¿™ä¹ˆè¯´ï¼š

- æˆ‘ä»¬æŸæŸç‰¹åˆ«ä¸¥æ ¼çš„åœºæ™¯ï¼Œç”¨çš„æ˜¯ TCC æ¥ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

  > ä½ æ‰¾ä¸€ä¸ªä¸¥æ ¼èµ„é‡‘è¦æ±‚ç»å¯¹ä¸èƒ½é”™çš„åœºæ™¯ï¼Œä½ å¯ä»¥è¯´ä½ æ˜¯ç”¨çš„ TCC æ–¹æ¡ˆã€‚

- ç„¶åå…¶ä»–çš„ä¸€äº›åœºæ™¯ï¼ŒåŸºäºé˜¿é‡Œçš„ RocketMQ æ¥å®ç°äº†åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

  > å¦‚æœæ˜¯ä¸€èˆ¬çš„åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯ï¼Œè®¢å•æ’å…¥ä¹‹åè¦è°ƒç”¨åº“å­˜æœåŠ¡æ›´æ–°åº“å­˜ï¼Œåº“å­˜æ•°æ®æ²¡æœ‰èµ„é‡‘é‚£ä¹ˆçš„æ•æ„Ÿï¼Œå¯ä»¥ç”¨å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆã€‚

## ä»€ä¹ˆæ˜¯ä¸‰é˜¶æ®µåè®®ï¼Ÿ

è¿™ä¸ªé—®é¢˜ï¼Œä¸¥æ ¼æ¥è¯´ä¸å±äºã€åˆ†å¸ƒå¼äº‹åŠ¡ã€‘ç›¸å…³ï¼Œè€ƒè™‘åˆ°æœ¬æ–‡å·²ç»å‡ºç°äº†ä¸€é˜¶æ®µæäº¤ã€äºŒé˜¶æ®µæäº¤ï¼Œæ‰€ä»¥è¿™é‡Œå°±ç¬æ—¶â€œç¡¬å¡â€ä¸€ä¸ªä¸‰é˜¶æ®µæäº¤ã€‚

æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šæ•°æ®åº“ åˆ†å¸ƒå¼äº‹åŠ¡ 2é˜¶æäº¤ 3é˜¶æäº¤ã€‹](https://www.jianshu.com/p/a20f1895d9c7) æ–‡ç« ã€‚

\##

## äº‹åŠ¡è§£å†³æ–¹æ¡ˆçš„å¯¹æ¯”æ€»ç»“

æ€»çš„æ¥è¯´ï¼ŒTCC å’Œ MQ éƒ½æ˜¯ä»¥æœåŠ¡ä¸ºèŒƒå›´è¿›è¡Œåˆ†å¸ƒå¼äº‹åŠ¡çš„å¤„ç†ï¼Œè€Œ XAã€BEDã€SAGA åˆ™æ˜¯ä»¥æ•°æ®åº“ä¸ºèŒƒå›´è¿›è¡Œåˆ†å¸ƒå¼å¤„ç†ã€‚

> å¯¹äºæ•°æ®åº“ä¸­é—´æ¥æ¥è¯´ï¼Œæ›´è¶‹å‘äºé€‰æ‹©åè€…ï¼Œå¯¹äºä¸šåŠ¡è€Œè¨€ä¾µå…¥å°ï¼Œæ”¹é€ çš„æˆæœ¬ä½ã€‚

![å¯¹æ¯”å›¾](http://static.iocoder.cn/c015006c18d7b4a59463fd00d589f2e1)

- å›¾ä¸­æš‚æ—¶æœªåŒ…æ‹¬ï¼š1ï¼‰æœ¬åœ°æ¶ˆæ¯è¡¨ï¼›2ï¼‰å¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ ã€‚å› ä¸ºï¼Œè¿™ä¸ªæ˜¯ Sharding Sphere å®˜æ–¹æä¾›çš„å›¾ï¼Œå˜»å˜»ã€‚

## å½©è›‹

ğŸ˜ˆ è™½ç„¶ä»¥å‰åŸºæœ¬è¯»è¿‡å¸‚é¢ä¸Šå¾ˆå¤šåˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆçš„æºç ï¼Œä½†æ˜¯å› ä¸ºæ˜¯æ–­æ–­ç»­ç»­çš„è¯»ï¼Œæ²¡æœ‰ä¸“é—¨èŠ±æ—¶é—´å»æ•´ç†ã€‚è¿™æ¬¡é‡æ–°æ•´ç†äº†ä¸‹ï¼Œæ”¶è·è¿˜æ˜¯è›®å¤šçš„ã€‚

å¦å¤–ï¼Œå¼€æºç¤¾åŒºé‡Œè¿˜æœ‰ä¸¤ä¸ªåŒç±»å‹çš„ 2PC äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ï¼š

> è‰¿è‰¿ï¼šä¸»è¦æˆ‘æ²¡æœ‰ç‰¹åˆ«ç ”ç©¶ï¼Œæ‰€ä»¥ä¹Ÿä¸å¤ªå¥½å†™ã€‚

- [Raincat](https://github.com/yu199195/Raincat)
- [LCN](https://github.com/codingapi/tx-lcn)

å‚è€ƒä¸æ¨èå¦‚ä¸‹æ–‡ç« ï¼š

- é«˜æ•ˆè¿ç»´ [ã€Šåˆ†å¸ƒå¼ç³»ç»Ÿçš„ CAP ç†è®ºã€‹](http://www.yunweipai.com/archives/8432.html)
- å’–å•¡æ‹¿é“ [ã€Šå†æœ‰äººé—®ä½ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒæŠŠè¿™ç¯‡æ‰”ç»™ä»–ã€‹](https://juejin.im/post/5b5a0bf9f265da0f6523913b)
- yanglbme [ã€Šåˆ†å¸ƒå¼äº‹åŠ¡äº†è§£å—ï¼Ÿä½ ä»¬å¦‚ä½•è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ï¼ŸTCC å¦‚æœå‡ºç°ç½‘ç»œè¿ä¸é€šæ€ä¹ˆåŠï¼ŸXA çš„ä¸€è‡´æ€§å¦‚ä½•ä¿è¯ï¼Ÿã€‹](https://github.com/doocs/advanced-java/blob/master/docs/distributed-system/distributed-transaction.md)



- [é¢è¯•é¢˜](javascript:void(0))







1. [ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E4%BB%80%E4%B9%88%E6%98%AF%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9F)
2. [ä¸ºä»€ä¹ˆä¼šæœ‰åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%EF%BC%9F)
3. [åˆ†å¸ƒå¼äº‹åŠ¡çš„åŸºç¡€ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9F%BA%E7%A1%80%EF%BC%9F)
4. [åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ä¸»è¦æœ‰å“ªäº›æ–¹æ¡ˆï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%BB%E8%A6%81%E6%9C%89%E5%93%AA%E4%BA%9B%E6%96%B9%E6%A1%88%EF%BC%9F)
5. èŠèŠ XA æ–¹æ¡ˆï¼Ÿ
   1. [å¼± XA](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%BC%B1-XA)
   2. [å¼º XA](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%BC%BA-XA)
   3. [åº”ç”¨åœºæ™¯](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF)
6. [èŠèŠ TCC æ–¹æ¡ˆï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%81%8A%E8%81%8A-TCC-%E6%96%B9%E6%A1%88%EF%BC%9F)
7. [èŠèŠæœ¬åœ°æ¶ˆæ¯è¡¨ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%81%8A%E8%81%8A%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8%EF%BC%9F)
8. [èŠèŠå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%81%8A%E8%81%8A%E5%8F%AF%E9%9D%A0%E6%B6%88%E6%81%AF%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E6%96%B9%E6%A1%88%EF%BC%9F)
9. èŠèŠæœ€å¤§åŠªåŠ›é€šçŸ¥æ–¹æ¡ˆï¼Ÿ
   1. [è§£é‡Šä¸€](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%A7%A3%E9%87%8A%E4%B8%80)
   2. [è§£é‡ŠäºŒ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%A7%A3%E9%87%8A%E4%BA%8C)
10. [èŠèŠ Saga æ–¹æ¡ˆï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E8%81%8A%E8%81%8A-Saga-%E6%96%B9%E6%A1%88%EF%BC%9F)
11. [ä½ ä»¬å…¬å¸æ˜¯å¦‚ä½•å¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E4%BD%A0%E4%BB%AC%E5%85%AC%E5%8F%B8%E6%98%AF%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%EF%BC%9F)
12. [ä»€ä¹ˆæ˜¯ä¸‰é˜¶æ®µåè®®ï¼Ÿ](http://svip.iocoder.cn/distributed-transaction/Interview/#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%89%E9%98%B6%E6%AE%B5%E5%8D%8F%E8%AE%AE%EF%BC%9F)
13. [äº‹åŠ¡è§£å†³æ–¹æ¡ˆçš„å¯¹æ¯”æ€»ç»“](http://svip.iocoder.cn/distributed-transaction/Interview/#%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E7%9A%84%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93)
14. [å½©è›‹](http://svip.iocoder.cn/distributed-transaction/Interview/#%E5%BD%A9%E8%9B%8B)

Â© 2019 èŠ‹é“æºç 

[Hexo](http://hexo.io/) Theme [Yilia](https://github.com/litten/hexo-theme-yilia) by Litten

æ€»è®¿å®¢æ•° 88014 æ¬¡

 

&&

 

æ€»è®¿é—®é‡ 575432 æ¬¡


  